name: Build and Deploy WAR

on:
  push:
    branches: [main]

jobs:
  scp-war:
    name: Build and upload war to server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Java 17 for Gradle
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "oracle"

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build frontend
        run: |
          cd frontend
          bun i --frozen-lockfile
          bun run build

      # Cache Gradle dependencies
      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare payara-service with frontend assets
        run: |
          mkdir -p payara-service/src/main/webapp
          cp -r frontend/out/* payara-service/src/main/webapp/

      - name: Build WAR with Gradle
        run: |
          ./gradlew :payara-service:war --no-daemon

      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-war
          path: payara-service/build/libs/*.war

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # SCP the WAR to your server
      - name: Deploy via SCP
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          DEPLOY_FOLDER: ~/info-systems-lab2
        run: sshpass -e scp -P "${{ secrets.SSH_PORT || 22 }}" payara-service/build/libs/*.war "${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}":${{env.DEPLOY_FOLDER}}/

  deploy-run:
    needs: scp-war
    name: Run deployed war
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Run payara
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          DEPLOY_FOLDER: "~/info-systems-lab2"
        run: |
          sshpass -e ssh -p "${{ secrets.SSH_PORT || 22 }}" "${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}" \
          "pkill java 2>/dev/null || true; \
          export POSTGRES_USER=${{ secrets.POSTGRES_USER }}; \
          export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}; \
          export POSTGRES_HOST=pg; \
          echo --port ${{ secrets.DEPLOY_PORT || 8080 }} > ${{ env.DEPLOY_FOLDER }}/payara.log; \
          nohup java \
            -Dorg.example.level=INFO \
            -Xmx1024m \
            -Xms512m \
            -jar ~/payara-micro-6.2025.10.jar \
            --deploy ${{ env.DEPLOY_FOLDER }}/app.war \
            --port ${{ secrets.DEPLOY_PORT || 8080 }} \
            --contextroot "/" \
          > ${{ env.DEPLOY_FOLDER }}/payara.log 2>&1 &"
